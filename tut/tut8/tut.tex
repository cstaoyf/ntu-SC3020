%\documentclass{...}

\input{./def/yf-formatting}

\usepackage{amsfonts, amsmath, amssymb, amsthm}
\usepackage{comment}
\usepackage{graphicx}
\usepackage{ifthen}
\usepackage{latexsym}
%\usepackage{times}
\usepackage[normalem]{ulem}

\input{./def/yf-def}

\def\dom{\prec}
\def\T{\mathcal{T}}

\newboolean{solver}\setboolean{solver}{true}
%\newboolean{solver}\setboolean{solver}{false}
\ifthenelse{\boolean{solver}}{\includecomment{sol}}{\excludecomment{sol}}

\begin{document}

\section*{SC3020-CE4301-CZ4031: Tutorial 8}
%Prepared by Yufei Tao \\

\begin{center}
    \uline{Classroom Discussion}
\end{center}

Consider three relations: $R_1(A, B)$ --- that is, a relation with attributes $A$ and $B$ --- $R_2(A, C)$, and $R_3(A, D)$, where $A$, $B$, and $C$ are all integer  attributes. We know the following facts:

\myitems{
    \item Fact 0.1: Each disk block can store 20 integer values.
    \item Fact 0.2: $|R_1| = |R_2| = |R_3| = 10^7$ (i.e., each relation has $10^7$ tuples). Each of $R_1$, $R_2$, and $R_3$ occupies $10^6$ disk blocks.
    \item Fact 0.3: The attribute $A$ is the primary key of $R_1$.
    \item Fact 0.4: There is a B-tree on $R_1$ indexing the attribute $A$. The B-tree has 3 levels.
    \item Fact 0.5: $R_1$ is sorted on $A$, but neither $R_2$ nor $R_3$ is sorted on $A$.
    \item Fact 0.6: The memory has $M = 2000$ blocks.
}

\extraspacing {\bf Problem 1.} Suppose we also know:
\myitems{
    \item Fact 1.1:
    50\% of the tuples in $R_2$ satisfy $C \ge 100$.
}
Given the query

%Describe how to process the following query with no more than $13 \times 10^6$ I/Os (the query result is displayed on screen).

\mytab{
    \> \ttt{select} * {from} $R_1, R_2, R_3$ \\
    \> \ttt{where} $R_1.A = R_2.A$ \ttt{and} $R_2.A = R_3.A$ \ttt{and} $R_2.C \ge 100$;
}
We execute it using the plan below:
\myenums{
    \item Scan $R_2$ to materialize
    \myeqn{
        %R_1' = \{\text{tuple } t \in R_1 \mid t.B \ge 100\} \nn \\
        R_4 = \{\text{tuple } t \in R_1 \mid t.C \ge 100\}. \nn
    }

    \item  Compute
    \myeqn{
        R_5 = R_1 \bowtie R_4 \nn
    }
    using hash-join (HJ) and materialize it.

    \item Compute $R_5 \bowtie R_3$ using HJ.
}
\noindent Provide an argument to show that the above plan performs no more than $12 \times 10^6$ I/Os. Whenever needed, you can make the good hashing assumption for the hash-join (HJ) algorithm.

\begin{sol}
\extraspacing {\bf Solution.} By Facts 0.2 and 1.1, the I/O cost of Step 1 is $10^6 + 5 \times 10^5 = 1.5 \times 10^6$ I/Os. The relation $R_4$ occupies $5 \times 10^5$ blocks. As $|R_4| = 5 \times 10^6$, Fact 0.3 tells us that $R_5$ has at most $5 \times 10^6$ tuples. A block can store $\lf 20/3 \rf = 6$ tuples of $R_5$ (each tuple has 3 integers). Hence, $R_5$ fits in $\lc 5 \times 10^6 / 6 \rc = 833,334$ blocks. The I/O cost of Step 2 is thus at most $3 (10^6 + 5 \times 10^5) + 833,334 = 5,333,334$. Finally, Step 3 takes $3 (833,334 + 10^6) = 5,500,002$ I/Os.

\vgap

The total cost is no more than $1.5 \times 10^6 + 5,333,334 + 5,500,002 = 12,333,336$ I/Os.

\end{sol}


\extraspacing {\bf Problem 2.} Describe an alternative plan to process the query in Problem 1 using at most $11.5 \times 10^6$ I/Os.

\begin{sol}
\extraspacing {\bf Solution.} First, compute and materialize $R_4$ in $1.5 \times 10^6$ I/Os as before. As $R_4$ occupies $5 \times 10^5$ blocks, sort $R_4$ on $A$ using $4 \times (5 \times 10^5) = 2 \times 10^6$ I/Os. We can then compute and materialize $R_5$ using sort-join (SJ) in $10^6 + 5 \times 10^5 + 833,334 = 2,333,334$ I/Os. Finally, computing $R_5 \bowtie R_3$ in $5,500,002$ I/Os as before.

\vgap

The total cost is no more than $1.5 \times 10^6 + 2 \times 10^6 + 2,333,334 + 5,500,002 = 11,333,336$ I/Os.

\end{sol}


\end{document}
