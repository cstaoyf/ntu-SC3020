%\documentclass{...}

\input{./def/yf-formatting}

\usepackage{amsfonts, amsmath, amssymb, amsthm}
\usepackage{comment}
\usepackage{graphicx}
\usepackage{ifthen}
\usepackage{latexsym}
%\usepackage{times}
\usepackage[normalem]{ulem}

\input{./def/yf-def}

\def\extraspacing{\vspace{5mm} \noindent}

\def\best{\mathit{best}}
\def\size{\mathit{size}}

\newboolean{solver}\setboolean{solver}{true}
%\newboolean{solver}\setboolean{solver}{false}
\ifthenelse{\boolean{solver}}{\includecomment{sol}}{\excludecomment{sol}}

\pagenumbering{gobble}

\begin{document}

.

\vspace{50mm}

\begin{center}
    \uline{SC3020-CE4301-CZ4031: Quiz 2}
\end{center}

\vspace{20mm}
\begin{center}
    Name:
    \uline{\hspace{30mm}}
    \hspace{10mm}
    Student ID:
    \uline{\hspace{30mm}}
\end{center}

\pagebreak

\extraspacing {\bf Problem 1 (60 marks).} Consider three relations: $R_1(A, B)$ --- that is, a relation with attributes $A$ and $B$ --- $R_2(A, C)$, and $R_3(A, D)$, where $A$, $B$, $C$, and $D$ are all integer  attributes. We are given the following query

\mytab{
    \ttt{select} * \ttt{from} $R_1, R_2, R_3$
    \ttt{where} $R_1.A = R_2.A$ \ttt{and} $R_2.A = R_3.A$ \ttt{and} $R_1.A \ge 100$ \ttt{and} $R_3.D \ge 100$;
}

\noindent and the following facts:

\myitems{
    \item Fact 1: Each disk block stores 20 integer values. \vspace{-1mm}
    \item Fact 2: $R_1, R_2$, and $R_3$ have $10^6$, $10^8$, and $10^6$ tuples, respectively. They occupy $10^5$, $10^7$, and $10^5$ disk blocks, respectively. \vspace{-1mm}
    \item Fact 3: For each tuple $t_1 \in R_1$, there are 100 tuples in $t_2 \in R_2$ satisfying $t_1.A = t_2.A$. \vspace{-1mm}
    \item Fact 4: The attribute $A$ is the primary key of $R_1$ and $R_3$. \vspace{-1mm}
    \item Fact 5: There is a clustered B-tree on $R_1$ indexing the attribute $A$. The B-tree has 3 levels. \vspace{-1mm}
    \item Fact 6: 10\% of the tuples in $R_1$ satisfy $A \ge 100$ and 1\% of the tuples in $R_3$ satisfy $D \ge 100$. \vspace{-1mm}
    \item Fact 7: The memory has $M = 900$ blocks. \vspace{-1mm}
}

\noindent Suppose that we process the query using the plan below:
\myenums{
    \item Use the B-tree to find $R_4 = \{\text{tuple } t_1 \in R_1 \mid t_1.A \ge 100\}$ and materialize it. \vspace{-1mm}

    \item  Compute $
        R_5 = R_4 \bowtie R_2 $
    using hash-join (HJ) and materialize it. \vspace{-1mm}

    \item Scan $R_3$ to find $R_6 = \{\text{tuple } t_3 \in R_3 \mid t_3.D \ge 100\}$ and materialize it. \vspace{-1mm}

    \item Compute $R_5 \bowtie R_6$ using sort join (SJ). \vspace{-1mm}
}
\noindent Provide an argument to show that the plan performs no more than {\bf $42$ million} I/Os, assuming that the query result is displayed on screen. Whenever needed, you can make the good hashing assumption for HJ.

\begin{sol}
    \extraspacing {\bf Solution.} By Fact 6, $R_4$ has $10^5$ tuples and fits in $10^4$ blocks. Using the B-tree, Step 1 can be done in $3 + 10^4 \text{ (for reading)} + 10^4 \text{ (for writing)} = 20003$ I/Os. As each tuple of $R_5$ has 3 integers, a block stores $\lf 20/3 \rf = 6$ tuples of $R_5$. By Fact 3, $R_5$ has $10^5 \times 100 = 10^7$ tuples and fits in $\lc 10^7 / 6 \rc = 1,666,667$ I/Os. Hence, Step 2 can be done in $3 \times (10000 + 10^7) + 1,666,667 = 31,696,667$ I/Os. By Fact 6, Step 3 takes $10^5 \text{ (for reading)} + 10^3 \text{ (for writing)} = 101,000$ blocks. For Step 4, the no-skew assumption holds because $A$ is the primary key of $R_3$. Thus, the step can be implemented in $5 \times (1,666,667 + 1000) = 8,338,335$ I/Os. The total I/O cost is therefore $40,156,005$ I/Os.
\end{sol}


\pagebreak
.

\vspace{100mm}

\extraspacing {\bf Problem 2 (40 marks).} Find a plan that can process the query in at most {\bf $21$ million} I/Os, assuming that the query result is displayed on screen. Whenever needed, you can make the good hashing assumption for HJ.

\vgap

You get 30 marks if your plan performs at most $31$ million I/Os.

\begin{sol}
    \extraspacing {\bf Solution.} Use the B-tree to find and materialize $R_4 = \{\text{tuple } t_1 \in R_1 \mid t_1.A \ge 100\}$ in 20003 I/Os. Scan $R_3$ to find and materialize $R_5 = \{\text{tuple } t_3 \in R_3 \mid t_3.D \ge 100\}$ in 101,000 I/Os. Use HJ to compute and materialize $R_6 = R_4 \bowtie R_5$ in $3 \times (10,000 + 1,000) = 33,000$ I/Os. Each block stores 6 tuples of $R_6$. As $R_6$ has at most $|R_5| = 10^4$ tuples ($A$ is the primary key of $R_6$), it fits in $\lc 10^4 / 6 \rc = 1667$ blocks. Use BNL to compute $R_2 \bowtie R_6$ in $1667 + \lc 1667 / 899 \rc \cdot 10^7 = 20,001,667$ blocks. The total I/O cost is therefore $20,155,670$.
\end{sol}

\end{document}
