%\documentclass{...}

\input{./def/yf-formatting}

\usepackage{amsfonts, amsmath, amssymb, amsthm}
\usepackage{comment}
\usepackage{graphicx}
\usepackage{ifthen}
\usepackage{latexsym}
%\usepackage{times}
\usepackage[normalem]{ulem}

\input{./def/yf-def}

\def\extraspacing{\vspace{5mm} \noindent}

\def\best{\mathit{best}}
\def\size{\mathit{size}}

\newboolean{solver}\setboolean{solver}{true}
%\newboolean{solver}\setboolean{solver}{false}
\ifthenelse{\boolean{solver}}{\includecomment{sol}}{\excludecomment{sol}}

\pagenumbering{gobble}

\begin{document}

.

\vspace{50mm}

\begin{center}
    \uline{SC3020-CE4301-CZ4031: Quiz 2 (Make-Up)}
\end{center}

\vspace{20mm}
\begin{center}
    Name:
    \uline{\hspace{30mm}}
    \hspace{10mm}
    Student ID:
    \uline{\hspace{30mm}}
\end{center}

\pagebreak

\extraspacing {\bf Problem 1 (60 marks).} Consider three relations: $R_1(A, B)$ --- that is, a relation with attributes $A$ and $B$ --- $R_2(B, C)$, and $R_3(C, D)$, where $A$, $B$, $C$, and $D$ are all integer attributes. We are given the query

\mytab{
    \ttt{select} $A$, \ttt{SUM}$(B)$ \ttt{from} $R_1$ \\
    \ttt{where} \ttt{exists} \\
    \> (\ttt{select} * \ttt{from} $R_2, R_3$ \ttt{where} $R_1.B = R_2.B$ \ttt{and} $R_2.C = R_3.C$ \ttt{and} $R_3.D \ge 100$ ) \\
    %) \\
    \ttt{group by} $A$

}

\noindent and the following facts:

\myitems{
    \item Fact 1: Each disk block stores 20 integer values. \vspace{-1mm}
    \item Fact 2: $R_1, R_2$, and $R_3$ have $10^4$, $10^8$, and $10^6$ tuples, respectively. They occupy $10^3$, $10^7$, and $10^5$ disk blocks, respectively. \vspace{-1mm}
    \item Fact 3: For each tuple $t_1 \in R_1$, there are 100 tuples in $t_2 \in R_2$ satisfying $t_1.B = t_2.B$. \vspace{-1mm}
    \item Fact 4: Attribute $B$ is the primary key of $R_1$, and attribute $C$ is the primary key of $R_2$ and $R_3$. \vspace{-1mm}
    \item Fact 5: $R_2$ has a hash index on attribute $B$. \vspace{-1mm}
    \item Fact 6: 10\% of the tuples in $R_3$ satisfy $D \ge 100$. \vspace{-1mm}
    \item Fact 7: The memory has $M = 500$ blocks. \vspace{-1mm}
}

\noindent Suppose that we process the query using the plan below:
\myenums{
    \item Compute $R'_3 = \set{t_3 \in R_3 \mid t_3.D \ge 100}$ and materialize it. \vspace{-1mm}
    \item Compute a relation $R'_1$ as follows. \vspace{-1mm}
    \myitems{
        \item For each tuple $t_1 \in R_1$, do the following: %\vspace{-1mm}
        \myitems{
            \item [2.1] Use the hash index to find $R_2'(t_1) = \set{t_2 \in R_2 \mid t_2.B = t_1.B}$. Keep $R'_2$ in memory. %\vspace{-1mm}

            \item [2.2] Determine whether the natural join $R'_3 \bowtie R'_2(t_1)$ has a non-empty result. If so, add $t_1$ to $R'_1$. %\vspace{-1mm}
        }
    }
    \item Materialize $R'_1$. \vspace{-1mm}
    \item Use sorting to group the tuples $R'_1$ by attribute $A$. Then, for each group, output the $A$-value and the sum of the $B$-values of the tuples therein.  \vspace{-1mm}
}
\noindent Provide an argument to show that the plan performs no more than {\bf $101$ million} I/Os, assuming that the query result is displayed on screen.
%Whenever needed, you can make the good hashing assumption for HJ.

\begin{sol}
    \extraspacing {\bf Solution.} As $R_3'$ has $10^5$ tuples and fits in $10^4$ blocks, Step 1 requires $10^5 + 10^4 = 110,000$ I/Os.

    \vgap

    For each tuple $t_1 \in R_1$, Step 2.1 performs $1 \text{ (for probing the hash index)} + 100/10 \text{ (for reading the}$ $\text{ tuples of $R'_2(t_1)$)} = 11$ I/Os, while Step 2.2 performs $10^4$ I/Os (reading $R'_3$). Hence, Step 2 performs in total $10^4 \times (11 + 10^4) = 100,110,000$ I/Os.

    \vgap


    Step 3 requires at most $10^3$ I/Os, and Step 4 takes at most $4 \times 10^3$ I/Os.

    \vgap

    The total I/O cost is $110,000 + 100,110,000 + 1,000 + 4,000 = 100,225,000$.
\end{sol}


\pagebreak
.

\vspace{100mm}

\extraspacing {\bf Problem 2 (40 marks).} Find a plan that can process the query in at most {\bf $31$ million} I/Os, assuming that the query result is displayed on screen. %Whenever needed, you can make the good hashing assumption for HJ.


\begin{sol}
    \extraspacing {\bf Solution.} Obtain $R_3'$ in $110,000$ I/Os as explained in the previous solution.

    \vgap

    Use HJ to compute $R_4 = \Pi_{B,C}(R_3' \bowtie R_2)$ in $3 \times (10^7 + 10^4)= 30,030,000$ I/Os. Note that $|R_4| \le |R_3'| = 10^5$. Materializing $R_4$ takes another $10^4$ I/Os at most.

    \vgap

    Now, compute $R_5 = \Pi_{A,B}(R_1 \bowtie R_4)$ using HJ in $3 \times (10^3 + 10^4) = 33,000$ I/Os. Note that $|R_5| \le |R_1| = 10^4$. Materializing $R_5$ takes at most $10^3$ I/Os.

    \vgap

    Finally, perform Step 4 of the plan in Question 1 using $4 \times 10^3$ I/Os.

    \vgap

    The total I/O cost is $110,000 + 30,030,000 + 10,000 + 33,000 + 4,000 = 30,187,000$.
\end{sol}

\end{document}
