\documentclass{beamer}

\usetheme{Warsaw}
%\usetheme{CambridgeUS}

\input{./def/yf-beamer.tex}
\usepackage{color}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage[skins,breakable]{tcolorbox}

\def\done{\hfill$\square$}
\def\ttt{\texttt}
\def\vgap{\vspace{5mm}}

\def\abt{\ttt{ABORT}}
\def\best{\mit{best}}
\def\cmt{\ttt{COMMIT}}
\def\ins{\ttt{INSERT}}
\def\rd{\ttt{READ}}
\def\size{\mit{size}}
\def\slock{\ttt{S-LOCK}}
\def\sort{\mit{sort}}
\def\upg{\ttt{UPGRADE}}
\def\ulock{\ttt{U-LOCK}}
\def\unlock{\ttt{UNLOCK}}
\def\wt{\ttt{WRITE}}
\def\xlock{\ttt{X-LOCK}}

\title[DATABASE SYSTEM PRINCIPLES]{Transactions 4:\\ Locking}

\author[Yufei Tao @ NTU]{Yufei Tao}
\institute[]{\url{https://www.cse.cuhk.edu.hk/~taoyf}}
\date{}

% \def\dtm{\mathit{d\mbox{-}tm}}
% \def\ftm{\mathit{f\mbox{-}tm}}
\def\bestext{\mathit{best\mbox{-}ext}}

\begin{document}
%-------------------------------------------------------------
\begin{frame}
    \titlepage
%     \begin{tcolorbox}[arc=0mm, colframe=green!50!black, colback=green!10!white] 
%     \end{tcolorbox}
\end{frame}
%-------------------------------------------------------------
\begin{frame}
\begin{small}
    Recall that the \bred{serializable} isolation level should be enforced for critical transactions (such as money transfers). This lecture will discuss how to guarantee this isolation level with \bred{locking}.
\end{small}    
\end{frame}
%-------------------------------------------------------------
\myfrm{
    \cbox{blue}{
        Transactions can only see themselves.
    }

    \vgap

    \cbox{green}{

    \blue{Example 1:} Suppose that we have two \blue{active} transactions (i.e., transactions in progress). \\[2mm]

    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    These transactions are not aware of each other.

    }


}
%-------------------------------------------------------------
\myfrm{
    \cbox{blue}{
        Database systems, which are \bred{multi-tasking} systems, execute the instructions of the active transactions in an interleaving manner. The mission of a \blue{concurrency control protocol} is to decide whether it is safe to execute an instruction without violating the target isolation level.
    }

    \vgap

    Today, we consider that \bred{serializable} is the target isolation level.

    \vgap

    \cbox{yellow}{
        We will discuss protocols based on a 3-way locking mechanism.
    }
}
%-------------------------------------------------------------
\myfrm{
    \xmybox{2-Phase Locking}

    \vgap

    \cbox{blue}{
        \blue{Rule 1:} Three locks: \bred{S} (\blue{shared}), \bred{U} (\blue{update}), and \bred{X} (\blue{exclusive}). Each lock applies to a database value (i.e., the value of a tuple under an attribute).
    }

    \cbox{blue}{
        \blue{Rule 2:} Before a transaction can \bred{read} a database value $\red{A}$, it must be holding an \bred{S- or a U-lock} on $A$. Before a transaction can \bred{write} a database value $\red{A}$, it must be holding an \bred{X-lock} on $A$.
    }


}
%-------------------------------------------------------------
\myfrm{
    \xmybox{2-Phase Locking}

    %\vgap

    \cbox{blue}{
        \blue{Rule 3:} (Compatibility Rules)
        \myitems{
            \item An S-lock on a value $\red{A}$ is \blue{compatible} with another S- or a U-lock on $A$.
            \item A U-lock on a value $\red{A}$ is \blue{compatible} with an S- or another U-lock on $A$.
        }

        An X-lock on a value $\red{A}$ is \bred{not compatible} with any other lock on $A$, regardless of its type.
    }

    \cbox{blue}{
        \blue{Rule 4:} To obtain a lock on a value $\red{A}$, a transaction needs to make a \blue{lock request}. The database grants the request only if the requested lock is \bred{compatible with the existing locks on $A$}.

        \vgap

        If granted, the transaction proceeds; otherwise (i.e., denied), the transaction is suspended until its request is granted.
    }
}
%-------------------------------------------------------------
\myfrm{
    \xmybox{2-Phase Locking}

    %\vgap

    \cbox{blue}{
        \blue{Rule 5:} A transaction releases a lock by making an \blue{unlock request}, which is always granted by the database.
    }

    \cbox{blue}{
        \blue{Rule 6:} If a transaction is holding a U-lock on a value $\red{A}$, it can issue an \blue{upgrade request} to acquire an X-clock on $A$. The database grants the request only if \bred{no other S- or U-locks exist on $A$}.

        \vgap

        If granted, the transaction releases the U-lock on $A$ and proceeds. Otherwise (i.e., denied), the transaction is suspended while holding the U-lock, until its request is granted.
    }
    \cbox{red}{
        Note: If a transaction is holding an S-lock on a value $\red{A}$, it \bred{cannot} request to upgrade the S-lock to an X-clock on $A$.
    }
}
%-------------------------------------------------------------
\myfrm{
    \xmybox{2-Phase Locking}

    \vgap

    \cbox{blue}{
        \blue{Rule 7:} Once a transaction issues an unlock request, it cannot issue any lock or upgrade request.
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2:} \\
    The transactions in Example 1 may be programmed as follows.

    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Both transactions obey Rules 1 and 7.

    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):} Let us assume that the database executes $T_1$ and $T_2$ in a ``round-robin'' manner, i.e., each cycle runs one instruction of each transaction. The $\red{\bm{\rightarrow}}$ symbol indicates the current instruction. \\[1mm]

    %The database does so by obeying Rules 3, 4, and 5.


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$ \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Granted: Rule 3, 4. $T_1$ now has the U-lock on $A$.

    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$  \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Denied: Rules 3, 4. \\
    $T_2$ is now suspended, waiting for an X-lock on $A$.

    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    $\red{\bm{\rightarrow}}$ \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    OK: Rule 2.


    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$  \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Denied: Rules 3, 4. \\
    $T_2$ continues to wait for an X-lock on $A$.

    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $\red{\bm{\rightarrow}}$ $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    OK: no locking issues.


    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$  \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Denied: Rules 3, 4. \\
    $T_2$ continues to wait for an X-lock on $A$.

    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    $\red{\bm{\rightarrow}}$ \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Granted: Rule 6! $T_2$ now holds an X-lock on $A$.


    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$  \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Denied: Rules 3, 4. \\
    $T_2$ continues to wait for an X-lock on $A$.

    }
}
%-------------------------------------------------------------

\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    $\red{\bm{\rightarrow}}$ \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    OK: Rule 2.


    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$  \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Denied: Rules 3, 4. \\
    $T_2$ continues to wait for an X-lock on $A$.

    }
}
%-------------------------------------------------------------

\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    $\red{\bm{\rightarrow}}$ \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Granted: Rule 5. $T_1$ holds no more locks on $A$.


    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$  \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Granted: Rules 3, 4. $T_2$ now holds an S-lock on $A$.

    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{
    \blue{Example (cont.).} The schedule produced:
    \begin{center}
        \begin{tabular}{c|c}
            $\red{T_1}$ & $\red{T_2}$ \\
            \hline
            \ulock$(A)$ &\\
            \rd($A$) &\\
            $A = A + 1$ & \\
            \upg$(A)$ &\\
            \wt($A$) &\\
            \unlock$(A)$ & \\
            &  \xlock$(A)$ \\
            &        \rd($A$) \\
            &        $A = A + 1$ \\
            &        \wt($A$) \\
            &        \unlock$(A)$ \\
                    \cmt & \\
            & \cmt
        \end{tabular}
    \end{center}
    }
}
%-------------------------------------------------------------
\end{document} 



