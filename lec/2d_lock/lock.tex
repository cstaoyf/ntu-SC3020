\documentclass{beamer}

\usetheme{Warsaw}
%\usetheme{CambridgeUS}

\input{./def/yf-beamer.tex}
\usepackage{color}
\usepackage{graphicx}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage[skins,breakable]{tcolorbox}

\def\done{\hfill$\square$}
\def\ttt{\texttt}
\def\vgap{\vspace{5mm}}

\def\abt{\ttt{ABORT}}
\def\best{\mit{best}}
\def\cmt{\ttt{COMMIT}}
\def\ins{\ttt{INSERT}}
\def\rd{\ttt{READ}}
\def\size{\mit{size}}
\def\slock{\ttt{S-LOCK}}
\def\sort{\mit{sort}}
\def\upg{\ttt{UPGRADE}}
\def\ulock{\ttt{U-LOCK}}
%\def\unlock{\ttt{UNLOCK}}
\def\wt{\ttt{WRITE}}
\def\xlock{\ttt{X-LOCK}}

\title[DATABASE SYSTEM PRINCIPLES]{Transactions 4:\\ Two Phase Locking}

\author[Yufei Tao @ NTU]{Yufei Tao}
\institute[]{\url{https://www.cse.cuhk.edu.hk/~taoyf}}
\date{}

% \def\dtm{\mathit{d\mbox{-}tm}}
% \def\ftm{\mathit{f\mbox{-}tm}}
\def\bestext{\mathit{best\mbox{-}ext}}

\begin{document}
%-------------------------------------------------------------
\begin{frame}
    \titlepage
%     \begin{tcolorbox}[arc=0mm, colframe=green!50!black, colback=green!10!white] 
%     \end{tcolorbox}
\end{frame}
%-------------------------------------------------------------
% \begin{frame}
% \begin{small}
%     Recall that the \bred{serializable} isolation level should be enforced for critical transactions (such as money transfers). This lecture will discuss how to do so with protocols based on \blue{two phase locking}.
% \end{small}
% \end{frame}
% %-------------------------------------------------------------
\myfrm{
    \cbox{blue}{
        Transactions can only see themselves.
    }

    \vgap

    \cbox{green}{

    \blue{Example 1:} Suppose that we have two \blue{active} transactions (i.e., transactions in progress). \\[2mm]

    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \wt($A$) \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \rd($B$) \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    These transactions are not aware of each other.

    }


}
%-------------------------------------------------------------
\myfrm{
    \cbox{blue}{
        Database systems, which are \bred{multi-tasking} systems, execute the instructions of the active transactions in an interleaving manner. The mission of a \blue{concurrency control protocol} is to decide whether it is safe to execute an instruction without violating the target isolation level.
    }

    \vgap

    Today, we consider that \bred{serializable} is the target isolation level. Recall that this isolation level should be enforced for critical transactions (such as money transfers).

    \vgap

    \cbox{yellow}{
        We will introduce a protocol called \blue{strict two-phase locking}.
    }
}
%-------------------------------------------------------------
\myfrm{
    \xmybox{Strict Two-Phase Locking (2PL)}

    \vgap

    \cbox{blue}{
        \blue{Rule 1:} Three locks: \bred{S} (\blue{shared}), \bred{U} (\blue{update}), and \bred{X} (\blue{exclusive}). Each lock applies to the value of a tuple in the database.
    }

    \cbox{blue}{
        \blue{Rule 2:} Before a transaction can \bred{read} a value $\red{A}$, it must be holding a lock (of an arbitrary type) on $A$. Before a transaction can \bred{write} a value $\red{A}$, it must be holding an \bred{X-lock} on $A$.
    }


}
%-------------------------------------------------------------
\myfrm{
    \xmybox{Strict Two-Phase Locking (2PL)}

    %\vgap

    \cbox{blue}{
        \blue{Rule 3:} To obtain a lock on a value $\red{A}$, a transaction needs to make a \blue{lock request}. The database grants the request only in the following scenarios:
        \myitems{
            \item the requested lock = S and \bred{all the locks on $A$ are S-locks};
            \item the requested lock = U and \bred{all the locks on $A$ are S-locks};
            \item the requested lock = X and \bred{there are no locks on $A$}.
        }

        If granted, the transaction proceeds; otherwise (i.e., denied), the transaction is suspended until its request is granted.
    }

    %\vgap

    %\cbox{blue}{
        %\blue{Rule 4:} A transaction releases a lock by making an \blue{unlock request}, which is always granted by the database.
    %}
}
%-------------------------------------------------------------
\myfrm{
    \xmybox{Strict Two-Phase Locking (2PL)}

    %\vgap

    \cbox{blue}{
        \blue{Rule 4:} If a transaction is holding a U-lock on a value $\red{A}$, it can issue an \blue{upgrade request} to acquire an X-clock on $A$. The database grants the request if \bred{no other locks exist on $A$}.

        \vgap

        If granted, the transaction releases the U-lock on $A$ and proceeds with an X-lock. Otherwise (i.e., denied), the transaction is suspended while holding the U-lock, until its request is granted.
    }
    \cbox{red}{
        Note: If a transaction is holding an S-lock on a value $\red{A}$, it \bred{cannot} request an upgrade to an X-clock on $A$.
    }
}
%-------------------------------------------------------------
\myfrm{
    \xmybox{Strict Two-Phase Locking (2PL)}

    \vgap

%     \cbox{blue}{
%         \blue{Rule 6:} Once a transaction issues an unlock request, it cannot issue any lock or upgrade request.
%     }

    \cbox{blue}{
        \blue{Rule 5:} A transaction releases locks only after having committed or aborted.
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2:} \\
    The transactions in Example 1 may be programmed as follows.

    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \slock$(B)$ \\
                    \rd($B$) \\
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    %Both transactions obey Rules 1 and 6.

    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):} Let us assume that the database executes $T_1$ and $T_2$ in a ``round-robin'' manner, i.e., each cycle runs one instruction of each transaction. The $\red{\bm{\rightarrow}}$ symbol indicates the current instruction. \\[1mm]

    %The database does so by obeying Rules 3, 4, and 5.


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$ \ulock$(A)$ \\
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \slock$(B)$ \\
                    \rd($B$) \\
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Granted (Rule 3).

    Lock status:
    \myitems{
        \item $T_1$: U-lock on $A$.
    }

    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$
                    \slock$(B)$ \\
                    \rd($B$) \\
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Granted (Rule 3).

    Lock status:
    \myitems{
        \item $T_1$: U-lock on $A$.
        \item $T_2$: S-lock on $B$.
    }


    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$ \rd($A$) \\
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \rd($B$) \\
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    OK (Rule 2).

    Lock status:
    \myitems{
        \item $T_1$: U-lock on $A$.
        \item $T_2$: S-lock on $B$.
    }
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$ \rd($B$) \\
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    OK (Rule 2).

    Lock status:
    \myitems{
        \item $T_1$: U-lock on $A$.
        \item $T_2$: S-lock on $B$.
    }
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$
                    $A = A + 1$ \\
                    \upg$(A)$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    OK (no locking issues).

    Lock status:
    \myitems{
        \item $T_1$: U-lock on $A$.
        \item $T_2$: S-lock on $B$.
    }
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    \upg$(A)$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Denied (Rule 3). \\
    $T_2$ is now suspended, waiting for an X-lock on $A$.

    \vgap

    Lock status:
    \myitems{
        \item $T_1$: U-lock on $A$.
        \item $T_2$: S-lock on $B$.
    }
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$ \upg$(A)$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Granted (Rule 4).

    Lock status:
    \myitems{
        \item $T_1$: X-lock on $A$.
        \item $T_2$: S-lock on $B$.
    }


    }
}
%-------------------------------------------------------------
% \myfrm{
%     \cbox{green}{
%
%     \blue{Example 2 (cont.):}
%
%
%     \begin{tabular}{cc}
%             \begin{minipage}{0.47\linewidth}
%                 \begin{center}
%                 \begin{tabular}{c}
%                     $\red{T_1}$ \\
%                     \hline
%                     \ulock$(A)$ \\
%                     \rd($A$) \\
%                     $A = A + 1$ \\
%                     \upg$(A)$ \\
%                     \wt($A$) \\
%                     %\unlock$(A)$ \\
%                     \cmt
%                 \end{tabular}
%                 \end{center}
%             \end{minipage}
%             &
%             \begin{minipage}{0.47\linewidth}
%                 \begin{center}
%                 \begin{tabular}{c}
%                     $\red{T_2}$ \\
%                     \hline
%                     $\red{\bm{\rightarrow}}$  \xlock$(A)$ \\
%                     \rd($A$) \\
%                     $A = A + 1$ \\
%                     \wt($A$) \\
%                     %\unlock$(A)$ \\
%                     \cmt
%                 \end{tabular}
%                 \end{center}
%             \end{minipage}
%         \end{tabular}
%
%     \vgap
%
%     Denied: Rule 3.
%     $T_2$ continues to wait for an X-lock on $A$.
%
%     }
% }
%-------------------------------------------------------------

\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$ \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    OK (Rule 2).

    Lock status:
    \myitems{
        \item $T_1$: X-lock on $A$.
        \item $T_2$: S-lock on $B$.
    }

    }
}
%-------------------------------------------------------------

\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$ %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    $T_1$ commits and releases the X-lock on $A$.


    Lock status:
    \myitems{
        \item $T_2$: S-lock on $B$.
    }
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{

    \blue{Example 2 (cont.):}


    \begin{tabular}{cc}
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_1}$ \\
                    \hline
                \end{tabular}
                \end{center}
            \end{minipage}
            &
            \begin{minipage}{0.47\linewidth}
                \begin{center}
                \begin{tabular}{c}
                    $\red{T_2}$ \\
                    \hline
                    $\red{\bm{\rightarrow}}$  \xlock$(A)$ \\
                    \rd($A$) \\
                    $A = A + B$ \\
                    \wt($A$) \\
                    %\unlock$(A)$ \\
                    \cmt
                \end{tabular}
                \end{center}
            \end{minipage}
        \end{tabular}

    \vgap

    Granted (Rule 3).

    Lock status:
    \myitems{
        \item $T_2$: S-lock on $B$ and X-lock on $A$.
    }
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{green}{
    \blue{Example 2 (cont.).} The schedule produced:
    \begin{center}
        \begin{tabular}{c|c}
            $\red{T_1}$ & $\red{T_2}$ \\
            \hline
            \ulock(A) & \\
            & \slock(B) \\
            \rd$(A)$ \\
            & \rd($B$) \\
            $A = A + 1$ & \\
            \upg$(A)$ &\\
            \wt($A$) &\\
            %%\unlock$(A)$ & \\
            \cmt & \\
            &  \xlock$(A)$ \\
            &        \rd($A$) \\
            &        $A = A + B$ \\
            &        \wt($A$) \\
            %&        %\unlock$(A)$ \\
            &        \cmt \\
        \end{tabular}
    \end{center}
    }
}
%-------------------------------------------------------------
\myfrm{
     \cbox{blue}{
        \blue{Theorem:} A schedule produced by the \bred{strict} 2PL protocol is always conflict-serializable and recoverable.
    }

    \vgap

     In our earlier example, $T_1$ and $T_2$ were run in a round-robin manner. The theorem holds \bred{regardless of the interleaving policy}. A cycle may run an arbitrary number of instructions of $T_1$ followed by an arbitrary number of instructions of $T_2$. The theorem will still hold.

     \vgap


}
%-------------------------------------------------------------
\myfrm{
    \cbox{blue}{
        Strict 2PL may create a \blue{deadlock}, which refers to a situation where at least two transactions get forever suspended from lock waiting.
    }

    \cbox{green}{
    \blue{Example 3.} Strict 2PL may result in
    \begin{center}
        \begin{tabular}{c|c}
            $\red{T_1}$ & $\red{T_2}$ \\
            \hline
            \xlock(A) & \\
            & \xlock(B) \\
            \slock$(B)$ \\
            & \slock($A$)
        \end{tabular}


    \end{center}

    The two transactions wait for each other forever.
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{blue}{
        A deadlock arises if and only if there is a \blue{waiting cycle} of the form: $\red{T_1 \rightarrow T_2 \rightarrow ... \rightarrow T_t \rightarrow T_1}$ for some $t \ge 2$, where $\red{T_i \rightarrow T_j}$ means $T_i$ waiting for $T_j$ to release a lock.
    }

    %\vgap

    To remedy a deadlock, the system may abort an arbitrary transaction in the waiting cycle.

    \cbox{green}{
    \blue{Example 3 (cont.).} Strict 2PL may result in
    \begin{center}
        \begin{tabular}{c|c}
            $\red{T_1}$ & $\red{T_2}$ \\
            \hline
            \xlock(A) & \\
            & \xlock(B) \\
            \slock$(B)$ \\
            & \slock($A$) \\
            & \ttt{ABORT} \\
            & (\bred{releasing the X-lock on $B$})
        \end{tabular}


    \end{center}

    Now $T_1$ can proceed.
    }
}
%-------------------------------------------------------------
\myfrm{
    \cbox{yellow}{
        \centering
        The content of the rest slides will not be tested.
    }
}
%-------------------------------------------------------------
\myfrm{
    Recall:
    \cbox{blue}{
        A \blue{phantom} refers to the situation where executing the same query twice returns different results even though the transaction performs no  modifications on the relevant data.
    }

    \cbox{green}{
        \blue{Example:} Relation $R(X, Y)$.

        \begin{center}
        \begin{tabular}{c|c}
            $\red{T_1}$ & $\red{T_2}$\\
            \hline
            find all $t \in R$ with $\red{t.X = 1}$ & \\
            & $\ins$ tuple $(1, y)$ in $R$ \\
            find all $t \in R$ with $\red{t.X = 1}$ & \\
            & \cmt \\
            \cmt &
        \end{tabular}
        \end{center}
    }

    \cbox{red}{
        \blue{Think:} How to use 2PL to avoid phantoms? \\
        \blue{Hint:} See the non-testable content of our previous lecture notes.
    }
}
%-------------------------------------------------------------
\end{document} 



